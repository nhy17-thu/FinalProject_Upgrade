<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'js/jquery-3.4.1.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js'%}"></script>
    <title>Upload and View Your Results</title>
</head>
<body>

    <button class="btn-default"><a href="{% url 'index' %}">back to main page</a></button>
    <p></p>

    <p>建议上传.jpg格式图片，否则可能出现错误</p>
    {# uploading pics #}
    <form enctype="multipart/form-data" action="{% url "upload" %}"  method="POST">
    {% csrf_token %}
    {% for field in form %}
        {{ field.label }}
         {{ field }}
    {% endfor %}
    <br><br>
    <button type="submit">upload</button>
    </form>
    <p></p>


    {% if uploaded %}
        <!-- 请求开始图片处理 -->
        <script>
        let startProcess = new XMLHttpRequest();
        startProcess.open('GET', '{% url 'start_processing' pic_id %}', true);
        startProcess.send();
        </script>


        <p>如下是你上传的图片：</p>
        <img src="" alt="uploaded image" id="upload_pic">
        <script>
        // 使用ajax实时预览上传照片
        let xmlHttp = new XMLHttpRequest();
        xmlHttp.open('GET', '{% url 'image' pic_id %}', true);     // 异步获取图片
        xmlHttp.responseType = "blob";  // 要求二进制流返回以显示图片
        xmlHttp.send();

        xmlHttp.onreadystatechange=function () {
            if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                // 从服务器以二进制流返回上传的图片结果
                document.getElementById('upload_pic').src = URL.createObjectURL(xmlHttp.response)
            }
        }
        </script>
        <p></p>


        <!-- 完成模型处理后检查返回结果 -->
        <p id="detection">图像Detection处理中……</p>
        <img src="" alt="Image Processing..." id="detection_pic">
        <script>
        // 使用ajax传输Detection处理结果
        let detectionXML = new XMLHttpRequest();
        console.log('request for detection result');
        detectionXML.open('GET', '{% url 'image_result' pic_id %}', true);     // 异步获取处理结果
        detectionXML.responseType = "blob";  // 要求二进制流返回以显示图片
        detectionXML.send();

        detectionXML.onreadystatechange=function () {
            if (detectionXML.readyState === 4 && detectionXML.status === 200) {
                // 从服务器以二进制流返回上传的图片结果
                document.getElementById('detection').innerText = 'Detection处理结果如下：';
                document.getElementById('detection_pic').src = URL.createObjectURL(detectionXML.response);
            }
        }
        </script>


        <p id="transfer">图像Style Transfer处理中……</p>
        <img src="" alt="Image Processing..." id="transfer_pic">
        <script>
        // 使用ajax传输Transfer处理结果
        let transferXML = new XMLHttpRequest();
        console.log('request for style transfer result');
        transferXML.open('GET', '{% url 'image_result_transfer' pic_id %}', true);     // 异步获取处理结果
        transferXML.responseType = "blob";  // 要求二进制流返回以显示图片
        transferXML.send();

        transferXML.onreadystatechange=function () {
            if (transferXML.readyState === 4 && transferXML.status === 200) {
                // 从服务器以二进制流返回上传的图片结果
                document.getElementById('transfer').innerText = 'Style Transfer处理结果如下：';
                document.getElementById('transfer_pic').src = URL.createObjectURL(transferXML.response);
            }
        }
        </script>


        <p></p>
        <p>在CIFAR-10数据集上训练的ResNet-18给出的分类预测结果如下：</p>
        <p id="class18">图像处理中……</p>
        <p>（CIFAR-10数据集共有: plane, car, bird, cat, deer, dog, frog, horse, ship, truck十类）</p>
        <script>
        let xml18 = new XMLHttpRequest();
        console.log('request for ResNet-18 result');
        xml18.open('GET', '{% url 'image_result_res18' pic_id %}', true);     // 异步获取处理结果
        xml18.send();

        xml18.onreadystatechange=function () {
            if (xml18.readyState === 4 && xml18.status === 200) {
                document.getElementById('class18').innerText = xml18.responseText;
            }
        }
        </script>


        <!-- 显示ResNet-152处理结果 -->
        <p></p>
        <p>在1000类ImageNet数据集上训练的ResNet-152给出的分类预测结果如下：</p>
        <p id="class152">图像处理中……</p>
        <script>
        let xml152 = new XMLHttpRequest();
        console.log('request for ResNet-152 result');
        xml152.open('GET', '{% url 'image_result_res152' pic_id %}', true);     // 异步获取处理结果
        xml152.send();

        xml152.onreadystatechange=function () {
            if (xml152.readyState === 4 && xml152.status === 200) {
                document.getElementById('class152').innerText = xml152.responseText;
            }
        }
        </script>

    {% endif %}

</body>
</html>